<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitud de cr√©dito</title>
  <style>
      /* --- Risk status badges --- */
  .risk-status{
    display:flex;
    gap:12px;
    margin-top:10px;
    flex-wrap:wrap;
  }

  .badge{
    padding:6px 14px;
    border-radius:999px;
    font-weight:700;
    font-size:0.85rem;
    letter-spacing:.2px;
    opacity:.25;
    border:1px solid transparent;
    user-select:none;
  }

  .badge.active{ opacity:1; }

  .badge.safe{
    background:rgba(34,197,94,.15);
    color:#22c55e;
    border-color:rgba(34,197,94,.4);
  }

  .badge.review{
    background:rgba(234,179,8,.15);
    color:#eab308;
    border-color:rgba(234,179,8,.4);
  }

  .badge.danger{
    background:rgba(239,68,68,.15);
    color:#ef4444;
    border-color:rgba(239,68,68,.4);
  }

  .risk-status-help{
    margin-top:8px;
    font-size:0.9rem;
    color: rgba(232, 238, 252, .75);
  }
    :root{
      --bg:#0b0f19; --card:#121a2a; --card2:#0f1626; --text:#e8eefc; --muted:#a9b4cc;
      --border:rgba(255,255,255,0.12); --focus:rgba(120,160,255,0.45);
      --ok:rgba(34,197,94,.35); --err:rgba(239,68,68,.35); --warn:rgba(245,158,11,.35);
    }
    *{box-sizing:border-box}
    body{
       margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1000px 700px at 20% 10%, #142241 0%, transparent 55%),
                  radial-gradient(900px 650px at 90% 30%, #1b2c54 0%, transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:24px;
    }
    #app{
      width:100%;
      min-height: calc(100vh - 48px); /* 24px top + 24px bottom del body */
      display:grid;
      place-items:center;
    }

    #presentation{
      width:100%;
      min-height: calc(100vh - 48px);
      display:grid;
      place-items:center;
      padding:24px 0;
    }
    .container{width:100%; max-width:920px}
    h1{margin:0 0 10px; font-size:22px}
    .subtitle{margin:0 0 18px; color:var(--muted); font-size:14px; line-height:1.35}

    .stepper{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 16px}
    .step{border:1px solid var(--border); background:rgba(255,255,255,0.04); color:var(--muted);
      padding:7px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .step.active{color:var(--text); border-color:rgba(120,160,255,0.55); box-shadow:0 0 0 4px rgba(120,160,255,0.10)}

    .choice-grid{display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:16px}
    .choice-card{
      background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:18px; min-height:160px;
      display:grid; gap:10px; cursor:pointer; user-select:none;
      transition:transform .12s ease, border-color .12s ease;
    }
    .choice-card:hover{transform:translateY(-2px); border-color:rgba(255,255,255,0.22)}
    .chip{
      justify-self:start;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
    }
    .choice-title{margin:0; font-size:18px; font-weight:800}
    .choice-desc{margin:0; color:var(--muted); font-size:14px; line-height:1.35}

    .panel{
      margin-top:18px; background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:18px;
    }
    .panel-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
    .panel-title{margin:0; font-size:16px; font-weight:800}

    .btn{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,0.06);
      color:var(--text); border-radius:10px; padding:10px 12px; cursor:pointer;
      transition:border-color .12s ease, transform .12s ease, opacity .12s ease;
      font-weight:700; font-size:13px;
    }
    .btn:hover{border-color:rgba(255,255,255,0.25); transform:translateY(-1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btn-primary{background:rgba(120,160,255,0.22); border-color:rgba(120,160,255,0.5)}
    .btn-danger{background:rgba(239,68,68,0.14); border-color:rgba(239,68,68,0.35)}

    .form-grid{display:grid; gap:12px; margin-top:10px}
    .row{
      display:grid; grid-template-columns:220px 1fr; gap:12px; align-items:center;
      padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.03);
    }
    label{font-size:13px; color:var(--muted); font-weight:700}
  input, select{
    width:100%;
    padding:11px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(0,0,0,0.18);
    color:var(--text);
    outline:none;
    font-size:14px;
  }

  select{
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    padding-right:46px;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%),
      linear-gradient(to right, rgba(255,255,255,0.12), rgba(255,255,255,0.12));
    background-position:
      calc(100% - 18px) 50%,
      calc(100% - 12px) 50%,
      calc(100% - 40px) 50%;
    background-size:6px 6px, 6px 6px, 1px 60%;
    background-repeat:no-repeat;
  }

  select option{
    background:#0f1626;
    color:#e8eefc;
  }
  /* =========================
     NEW CLIENT (Mega-form) UI
     - Reutiliza tu tema oscuro
     ========================= */

  .section{
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    border-radius:14px;
    padding:14px;
  }

  .section + .section{ margin-top:12px; }

  .section-title{
    margin:0 0 10px;
    font-size:13px;
    color:var(--muted);
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.7px;
    display:flex;
    align-items:center;
    gap:10px;
  }

  .section-title::before{
    content:"";
    width:4px;
    height:16px;
    border-radius:2px;
    background:rgba(120,160,255,0.75);
  }

  .grid-2{
    display:grid;
    grid-template-columns:repeat(2, minmax(240px, 1fr));
    gap:12px;
  }

  .grid-3{
    display:grid;
    grid-template-columns:repeat(3, minmax(200px, 1fr));
    gap:12px;
  }

  .checkbox-grid{
    display:grid;
    grid-template-columns:repeat(3, minmax(180px, 1fr));
    gap:10px;
  }

  .check{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(0,0,0,0.16);
    user-select:none;
  }

  .check input[type="checkbox"]{
    width:18px;
    height:18px;
    accent-color: rgba(120,160,255,0.95);
  }

  .check span{
    font-size:13px;
    color:rgba(232,238,252,.9);
    font-weight:700;
  }

  .hint{
    font-size:12px;
    color:rgba(232, 238, 252, .65);
    margin-top:6px;
    line-height:1.35;
  }

  @media (max-width:720px){
    .grid-2, .grid-3{ grid-template-columns:1fr; }
    .checkbox-grid{ grid-template-columns:1fr; }
    select:invalid{ color: rgba(169,180,204,0.85); }
    select option[value=""]{ color: rgba(169,180,204,0.85); }
  }

    input:focus, select:focus{
      border-color:rgba(120,160,255,0.55);
      box-shadow:0 0 0 4px var(--focus);
    }

    .field-error{margin-top:6px; font-size:12px; color:rgba(255,255,255,0.85)}
    .field-error strong{color:rgba(239,68,68,0.95)}
    .hidden{display:none !important}


    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap}
    .status{
      margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(0,0,0,0.18); color:var(--muted); white-space:pre-wrap;
    }
    .status.ok{border-color:var(--ok)} .status.err{border-color:var(--err)} .status.warn{border-color:var(--warn)}

    .summary{border:1px solid var(--border); background:rgba(255,255,255,0.03); border-radius:12px; overflow:hidden}
    .summary-row{display:grid; grid-template-columns:220px 1fr; gap:12px; padding:12px; border-bottom:1px solid var(--border)}
    .summary-row:last-child{border-bottom:0}
    .summary-k{color:var(--muted); font-weight:800; font-size:13px}
    .summary-v{font-weight:800}

    /* =============================
       RESULT UI (VISUAL + NI√ëOS)
       ============================= */
    .result-hero{
      display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:12px;
    }
    .result-box{
      border:1px solid var(--border);
      background:rgba(0,0,0,0.18);
      border-radius:14px;
      padding:14px;
    }
    .bigRow{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .bigTitle{font-size:12px; color:var(--muted); font-weight:800}
    .bigValue{font-size:22px; font-weight:900}

    .traffic{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border);
      font-weight:900; letter-spacing:.3px;
    }
    .traffic.safe{border-color:var(--ok); background:rgba(34,197,94,.12)}
    .traffic.care{border-color:var(--warn); background:rgba(245,158,11,.12)}
    .traffic.danger{border-color:var(--err); background:rgba(239,68,68,.12)}

    .meter{margin-top:10px}
    .meterTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .meterBar{
      height:14px; border-radius:999px; overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.08);
      margin-top:8px;
    }
    .meterFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.8), rgba(245,158,11,.8), rgba(239,68,68,.8));
      transition:width .25s ease
    }
    .ticks{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:6px}

    .split{
      display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px;
    }
    .listTitle{margin:0 0 10px; font-size:13px; color:var(--muted); font-weight:900; text-transform:uppercase; letter-spacing:.6px}

    .fact{
      padding:10px; border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      margin-bottom:10px;
    }
    .factTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .factName{font-weight:900}
    .factMini{color:var(--muted); font-size:12px}
    .factBar{height:10px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,0.08); border:1px solid var(--border); margin-top:8px}
    .factFillBad{height:100%; width:0%; background:rgba(239,68,68,.75); transition:width .25s ease}
    .factFillOk{height:100%; width:0%; background:rgba(34,197,94,.75); transition:width .25s ease}

    details.json-details{margin-top:12px}
    details.json-details summary{cursor:pointer; color:var(--muted); font-weight:800}
    pre.json-pre{
      margin:10px 0 0;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      max-height:340px;
      font-size:12px;
      color: var(--text);
    }

    @media (max-width:720px){
      .choice-grid{grid-template-columns:1fr}
      .row, .summary-row{grid-template-columns:1fr}
      .result-hero{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
    }

    /* =========================
   Presentation toggle (UI)
   ========================= */
.top-fab{
  position:fixed;
  top:16px;
  right:16px;
  z-index:1000;
}
.btn-mini{
  padding:8px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
  background:rgba(255,255,255,0.06);
  border:1px solid var(--border);
  color:var(--text);
  cursor:pointer;
  transition:transform .12s ease, border-color .12s ease, opacity .12s ease;
}
.btn-mini:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,0.25); }
.btn-mini:active{ transform:translateY(0px); }

.presentation-wrap{
  width:100%;
  max-width:1100px;
  margin:0 auto;
}
.presentation-card{
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
}
.presentation-card h2{
  margin:0 0 10px;
  font-size:18px;
  font-weight:900;
}
.presentation-content{
  color:rgba(232,238,252,.92);
  line-height:1.55;
  font-size:14px;
}
.presentation-content img{
  max-width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  display:block;
  margin:14px auto;
}
.presentation-actions{
  display:flex;
  justify-content:center;
  margin-top:16px;
}

/* ===== Presentation: tables like docs ===== */
.pres-block{ margin-top:18px; }
.pres-h3{ margin:0 0 10px; font-size:20px; font-weight:900; }
.pres-h4{ margin:14px 0 8px; font-size:14px; font-weight:900; color:rgba(232,238,252,.92); }
.pres-note{ color:rgba(232,238,252,.86); line-height:1.55; margin:0 0 8px; }

.auc-list{ margin:6px 0 10px 18px; padding:0; }
.auc-list li{ margin:0; color:rgba(232,238,252,.92); font-weight:800; }
.auc-list strong{ font-weight:900; }

.pres-table{
  width:100%;
  border-collapse:collapse;
  margin:10px 0 18px;
  background:rgba(0,0,0,0.18);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
.pres-table th, .pres-table td{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,0.10);
  text-align:left;
  font-size:13px;
}
.pres-table th{
  font-weight:900;
  color:rgba(232,238,252,.95);
  background:rgba(255,255,255,0.05);
}
.pres-table td{ color:rgba(232,238,252,.90); font-weight:700; }
.pres-table tr:last-child td{ border-bottom:none; }

  </style>
</head>

<body>
   <!-- Bot√≥n peque√±o fijo -->
  <div class="top-fab">
    <button class="btn-mini" id="btn-presentation" type="button">üìΩÔ∏è Presentaci√≥n</button>
  </div>

  <!-- PRESENTACI√ìN (oculta por defecto) -->
  <section id="presentation" class="hidden presentation-wrap" aria-label="Presentaci√≥n">
    <div class="presentation-card">
      <h2>Presentaci√≥n del proyecto</h2>

<div class="presentation-content" id="presentation-content">

  <h2 style="margin-top:0">Proyecto de Modelo de predicci√≥n de Riesgo Crediticio</h2>

  <p>
    El objetivo de este proyecto es desarrollar un modelo predictivo capaz de estimar la probabilidad de default de un solicitante y,
    al mismo tiempo, proporcionar explicabilidad caso por caso. Esto permite comprender con mayor precisi√≥n los factores que influyen
    en la decisi√≥n y fundamentar cada evaluaci√≥n crediticia con informaci√≥n clara y transparente.
  </p>

  <p>
    Adem√°s, este enfoque no solo aporta valor anal√≠tico, sino que tambi√©n responde a las exigencias regulatorias vigentes en la Uni√≥n Europea,
    que han establecido l√≠mites expl√≠citos al uso de algoritmos opacos o de ‚Äúcaja negra‚Äù en decisiones automatizadas que afectan significativamente
    a las personas. En particular, el Art√≠culo 22 del Reglamento General de Protecci√≥n de Datos (GDPR) establece que los individuos tienen derecho
    a no ser objeto de decisiones basadas √∫nicamente en procesos automatizados cuando estas produzcan efectos legales o de impacto significativo,
    y abre la puerta a un derecho a explicaci√≥n.
  </p>

  <hr style="border:0;border-top:1px solid rgba(255,255,255,0.12); margin:16px 0" />

  <h3>Exploraci√≥n inicial del dataset</h3>
  <p>
    Antes de construir el modelo, realizamos un an√°lisis exploratorio para comprender la estructura de los datos, detectar patrones relevantes y
    evaluar la calidad de la informaci√≥n disponible. Este paso fue clave para identificar relaciones entre variables, posibles sesgos y transformaciones
    necesarias para el modelado.
  </p>
  <p>
    Uno de los primeros hallazgos fue que el dataset presenta un fuerte desbalance: la gran mayor√≠a de los clientes pagaron correctamente mientras que
    solo una minor√≠a incurri√≥ en default. Este desbalance condiciona el enfoque del modelado y obliga a utilizar m√©tricas adecuadas para evaluar el desempe√±o
    del modelo.
  </p>

  <img src="/static/presentation/output.png" alt="Ingresos vs Target" />


  <h3>An√°lisis de variables socioecon√≥micas</h3>
  <p>
    Durante el an√°lisis exploratorio se estudiaron distintas caracter√≠sticas demogr√°ficas y financieras de los solicitantes. Algunas observaciones destacadas fueron:
  </p>

  <h4 style="margin-bottom:6px">Diferencias por g√©nero</h4>
  <p>
    Los datos muestran que los hombres presentan una mayor probabilidad de incurrir en default en comparaci√≥n con las mujeres. Si bien la diferencia no es extrema,
    s√≠ es consistente a lo largo de distintos rangos de edad e ingresos, lo que sugiere un patr√≥n relevante para el an√°lisis de riesgo.
  </p>
  <img src="/static/presentation/genero.png" alt="Diferencias por g√©nero" />

  <h4 style="margin-bottom:6px">Relaci√≥n entre edad y riesgo</h4>
  <p>
    Se observa una relaci√≥n inversa entre la edad y la tasa de default: a medida que aumenta la edad del solicitante, la probabilidad de default tiende a disminuir.
    Este comportamiento puede estar asociado a mayor estabilidad laboral, ingresos m√°s consolidados o menor propensi√≥n al endeudamiento en edades avanzadas.
  </p>

  <!-- Si renombraste el archivo, usa montanas_tarjet.png -->
  <img src="/static/presentation/target.png" alt="Exploraci√≥n inicial / desbalance" />

  <h4 style="margin-bottom:6px">Relaci√≥n entre monto del Cr√©dito y Target</h4>
  <p>
    Lo interesante es que la proporci√≥n de clientes en default no es uniforme a lo largo del eje de cr√©dito: en los montos m√°s bajos, la tasa de default es relativamente baja.
    En los montos intermedios (por ejemplo, entre 300 000 y 600 000), se observa un aumento en la frecuencia relativa de default.
    En los montos m√°s altos, la tasa vuelve a bajar, posiblemente porque esos clientes tienen mayor solvencia o mejores perfiles crediticios.
  </p>
  <p>
    Este patr√≥n sugiere que la relaci√≥n entre monto del cr√©dito y riesgo no es lineal. No se puede afirmar que ‚Äúa mayor cr√©dito, mayor riesgo‚Äù ni lo contrario.
    Hay un rango cr√≠tico donde el riesgo se intensifica.
  </p>
  <img src="/static/presentation/montanas.png" alt="Monto del cr√©dito vs Target" />

  <h4 style="margin-bottom:6px">Relaci√≥n entre Ingresos y target</h4>
  <p>
    Este gr√°fico revela una tendencia: los clientes con mayores niveles de ingreso tienden a presentar una menor probabilidad de incurrir en default.
    Este comportamiento es coherente con la l√≥gica financiera, ya que una mayor capacidad de pago suele estar asociada a un menor riesgo crediticio.
  </p>
  <p>
    No obstante, el gr√°fico tambi√©n evidencia que el ingreso no constituye una garant√≠a absoluta. Se observan casos de default incluso en rangos medios de ingreso,
    lo que sugiere que el riesgo crediticio est√° influido por m√∫ltiples factores.
  </p>
  <img src="/static/presentation/mantas.png" alt="Exploraci√≥n inicial / desbalance" />

  <h4 style="margin-bottom:6px">Relaci√≥n entre el d√≠a que pide el cr√©dito y Target</h4>
  <p>
    Existe una relaci√≥n entre el d√≠a de la semana que se pide el cr√©dito y la taza de default. Este patr√≥n sugiere que el d√≠a de la semana en que se solicita el cr√©dito
    podr√≠a aportar informaci√≥n adicional sobre el perfil de riesgo del solicitante. Aunque no es una variable causal directa, puede funcionar como un indicador complementario
    en el modelo.
  </p>
<img src="/static/presentation/dias de la semana.png" alt="Exploraci√≥n inicial / desbalance" />

  <hr style="border:0;border-top:1px solid rgba(255,255,255,0.12); margin:16px 0" />

<div class="pres-block">
  <h3 class="pres-title">Pruebas</h3>

  <p class="pres-subtitle">Primeras pruebas con el Dataset crudo en XGBoost:</p>
  <ul class="auc-list">
    <li><strong>AUC Score:</strong> 0.7805</li>
  </ul>

  <table class="pres-table" aria-label="M√©tricas XGBoost crudo">
    <thead>
      <tr>
        <th>Clase</th>
        <th>Precision</th>
        <th>Recall</th>
        <th>F1Score</th>
        <th>Support</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Paga</td>
        <td>0.95</td>
        <td>0.90</td>
        <td>0.92</td>
        <td>56538</td>
      </tr>
      <tr>
        <td>No paga</td>
        <td>0.28</td>
        <td>0.42</td>
        <td>0.33</td>
        <td>4965</td>
      </tr>
    </tbody>
  </table>

  <h3 class="pres-title" style="font-size:18px;margin-top:6px;">Problemas</h3>
  <p class="pres-note">
    El dataset ten√≠a outliers (datos extremadamente altos o bajos) y columnas que no eran importantes para el entrenamiento del modelo.
  </p>

  <p class="pres-subtitle">Limpiando el Dataset y con un primer intento de balancear el dataset obtuvimos estos resultados:</p>
  <ul class="auc-list">
    <li><strong>AUC Score:</strong> 0.77509</li>
  </ul>

  <table class="pres-table" aria-label="M√©tricas limpieza + balanceo (intento 1)">
    <thead>
      <tr>
        <th>Clase</th>
        <th>Precision</th>
        <th>Recall</th>
        <th>F1Score</th>
        <th>Support</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Paga</td>
        <td>0.96</td>
        <td>0.80</td>
        <td>0.84</td>
        <td>61503</td>
      </tr>
      <tr>
        <td>No paga</td>
        <td>0.21</td>
        <td>0.60</td>
        <td>0.31</td>
        <td>61503</td>
      </tr>
    </tbody>
  </table>

  <h3 class="pres-title" style="font-size:18px;margin-top:6px;">Problemas</h3>
  <p class="pres-note">
    La t√©cnica de balanceo inicial no fue la adecuada, as√≠ que probamos otra estrategia y detectamos qu√© variables afectaban m√°s al modelo.
  </p>

  <p class="pres-note">
    Agregamos columnas para aportar m√°s granularidad, probamos CatBoost y LightGBM, y usamos Optuna para optimizar y comparar modelos.
  </p>

  <ul class="auc-list">
    <li><strong>AUC Score:</strong> 0.7781</li>
  </ul>

  <table class="pres-table" aria-label="M√©tricas con nuevas features + Optuna">
    <thead>
      <tr>
        <th>Clase</th>
        <th>Precision</th>
        <th>Recall</th>
        <th>F1Score</th>
        <th>Support</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Paga</td>
        <td>0.97</td>
        <td>0.65</td>
        <td>0.78</td>
        <td>46061</td>
      </tr>
      <tr>
        <td>No paga</td>
        <td>0.17</td>
        <td>0.78</td>
        <td>0.29</td>
        <td>4367</td>
      </tr>
    </tbody>
  </table>

  <h3 class="pres-title" style="font-size:18px;margin-top:6px;">Problemas</h3>
  <p class="pres-note">
    La optimizaci√≥n todav√≠a era mejorable; los resultados pod√≠an subir.
  </p>

  <p class="pres-note">
    Tras m√∫ltiples iteraciones con distintos modelos y t√©cnicas de optimizaci√≥n, el mejor resultado se obtuvo con CatBoost.
  </p>

  <ul class="auc-list">
    <li><strong>AUC Score:</strong> 0.81331</li>
  </ul>

  <table class="pres-table" aria-label="M√©tricas finales CatBoost">
    <thead>
      <tr>
        <th>Clase</th>
        <th>Precision</th>
        <th>Recall</th>
        <th>F1Score</th>
        <th>Support</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Paga</td>
        <td>0.97</td>
        <td>0.74</td>
        <td>0.84</td>
        <td>138182</td>
      </tr>
      <tr>
        <td>No paga</td>
        <td>0.21</td>
        <td>0.73</td>
        <td>0.33</td>
        <td>13101</td>
      </tr>
    </tbody>
  </table>
</div>

  <h3>Mejoras</h3>
  <ul>
    <li><strong>Integraci√≥n con SQL para acelerar la b√∫squeda de usuarios</strong>
      <ul>
        <li>Profesionaliza el proyecto: pas√°s de trabajar con CSVs a una base de datos real.</li>
        <li>Permite consultas m√°s r√°pidas, especialmente si el dataset es grande.</li>
        <li>Facilita filtrar usuarios por: ID, ingresos, historial crediticio, features del modelo.</li>
        <li>Te abre la puerta a usar √≠ndices, vistas y joins.</li>
      </ul>
    </li>
    <li><strong>Modelo de recomendaci√≥n KNN para sugerir mejoras al usuario</strong>
      <ul>
        <li>‚ÄúUsuarios similares a ti mejoraron su score aumentando X‚Äù</li>
        <li>‚ÄúTu probabilidad de default bajar√≠a si reduces Y‚Äù</li>
        <li>Transforma el modelo en una herramienta de apoyo y no solo de evaluaci√≥n.</li>
      </ul>
    </li>
  </ul>

</div>
        </section>

  <!-- APP (tu contenido actual) -->
  <section id="app">
    <main class="container">
    <h1>Solicitud de cr√©dito</h1>
    <p class="subtitle">Frontend conectado a FastAPI (scoring existente + registro nuevo). Explicaci√≥n visual para demo.</p>

    <div class="stepper" aria-label="Progreso">
      <span class="step" id="step-1">1) Selecci√≥n</span>
      <span class="step" id="step-2">2) Datos</span>
      <span class="step" id="step-3">3) Confirmar</span>
      <span class="step" id="step-4">4) Resultado</span>
    </div>

    <section id="screen-choice" class="choice-grid" aria-label="Selecci√≥n">
      <div class="choice-card" id="btn-existing" role="button" tabindex="0">
        <span class="chip">üë§ Cliente existente</span>
        <h2 class="choice-title">Cliente existente</h2>
        <p class="choice-desc">Calcula riesgo usando SK_ID_CURR.</p>
      </div>

      <div class="choice-card" id="btn-new" role="button" tabindex="0">
        <span class="chip">‚ú® Nuevo cliente</span>
        <h2 class="choice-title">Nuevo cliente</h2>
        <p class="choice-desc">Registro de cliente.</p>
      </div>
    </section>

    <!-- Existing -->
    <section id="screen-existing" class="panel hidden" aria-label="Existente">
      <div class="panel-header">
        <h3 class="panel-title">Cliente existente ‚Üí Datos del cr√©dito</h3>
        <button class="btn" id="btn-back-existing" type="button">‚Üê Volver</button>
      </div>

      <form id="form-existing" novalidate>
        <div class="form-grid">
          <div class="row">
            <label for="skIdCurr">SK_ID_CURR</label>
            <div>
              <input id="skIdCurr" name="skIdCurr" type="number" min="1" placeholder="Ej: 10293" required />
              <div class="field-error hidden" id="err-sk"><strong>Error:</strong> SK_ID_CURR debe ser un n√∫mero > 0.</div>
            </div>
          </div>

          <div class="row">
            <label for="amtCredit">Cantidad de cr√©dito</label>
            <div>
              <input id="amtCredit" name="amtCredit" type="number" min="0" step="0.01" placeholder="Ej: 5000" required />
              <div class="field-error hidden" id="err-amt"><strong>Error:</strong> La cantidad debe ser mayor que 0.</div>
            </div>
          </div>

          <div class="row">
            <label for="creditType">Tipo de cr√©dito</label>
            <div>
              <select id="creditType" name="creditType" required aria-required="true" aria-describedby="err-type">
                <option value="" selected disabled>Selecciona un tipo de cr√©dito</option>
                <option value="revolving_loans">Cr√©dito revolving</option>
                <option value="cash_loans">Pr√©stamo personal</option>
              </select>
              <div class="field-error hidden" id="err-type"><strong>Error:</strong> Selecciona un tipo de cr√©dito.</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="reset">Limpiar</button>
          <button class="btn btn-primary" type="submit">Continuar</button>
        </div>

        <div class="status hidden" id="status-existing"></div>
      </form>
    </section>

<!-- New (MEGA FORM con tu estilo) -->
<section id="screen-new" class="panel hidden" aria-label="Nuevo cliente">
  <div class="panel-header">
    <h3 class="panel-title">Nuevo cliente ‚Üí Datos completos</h3>
    <button class="btn" id="btn-back-new" type="button">‚Üê Volver</button>
  </div>

  <form id="form-new" novalidate>

      <div class="section">
    <p class="section-title">Identificaci√≥n</p>
    <div class="grid-2">

      <div class="row">
        <label for="fullName">Nombre completo</label>
        <div>
          <input id="fullName" name="fullName" type="text" placeholder="Ej: Juan P√©rez" required />
          <div class="field-error hidden" id="err-name"><strong>Error:</strong> Nombre requerido.</div>
        </div>
      </div>

      <div class="row">
        <label for="dni">DNI/NIE</label>
        <div>
          <input id="dni" name="dni" type="text" placeholder="Ej: 12345678Z" required />
          <div class="field-error hidden" id="err-dni"><strong>Error:</strong> DNI/NIE requerido.</div>
        </div>
      </div>

      <div class="row">
        <label for="email">Email</label>
        <div>
          <input id="email" name="email" type="email" placeholder="Ej: juan@email.com" required />
          <div class="field-error hidden" id="err-email"><strong>Error:</strong> Email v√°lido requerido.</div>
        </div>
      </div>

      <div class="row">
        <label for="phone">Tel√©fono</label>
        <div>
          <input id="phone" name="phone" type="tel" placeholder="Ej: 600123123" required />
          <div class="field-error hidden" id="err-phone"><strong>Error:</strong> Tel√©fono requerido.</div>
        </div>
      </div>

    </div>
  </div>
    <!-- 1) Contrato -->
    <div class="section">
      <p class="section-title">Informaci√≥n del contrato</p>
      <div class="grid-2">
        <div class="row">
          <label for="nc_contract_type">Tipo de contrato</label>
          <div>
            <select id="nc_contract_type" name="contract_type" required>
              <option value="" selected disabled>Selecciona</option>
              <option value="Cash loans">Pr√©stamo personal</option>
              <option value="Revolving loans">Cr√©dito revolving</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="nc_annuity">Anualidad</label>
          <div>
            <input id="nc_annuity" name="annuity" type="number" step="0.01" min="0" placeholder="Ej: 25000" />
          </div>
        </div>

        <div class="row">
          <label for="nc_goods_price">Precio de bienes</label>
          <div>
            <input id="nc_goods_price" name="goods_price" type="number" step="0.01" min="0" placeholder="Ej: 450000" />
          </div>
        </div>
      </div>
    </div>

    <!-- 2) Personal -->
    <div class="section">
      <p class="section-title">Informaci√≥n personal</p>
      <div class="grid-2">
        <div class="row">
          <label for="nc_gender">G√©nero</label>
          <div>
            <select id="nc_gender" name="gender" required>
              <option value="" selected disabled>Selecciona</option>
              <option value="M">Masculino</option>
              <option value="F">Femenino</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="nc_children">N√∫mero de hijos</label>
          <div>
            <input id="nc_children" name="children" type="number" min="0" value="0" />
          </div>
        </div>

        <div class="row">
          <label for="nc_family_members">Miembros de familia</label>
          <div>
            <input id="nc_family_members" name="family_members" type="number" min="1" value="2" />
          </div>
        </div>

        <div class="row">
          <label for="nc_age_years">Edad (a√±os)</label>
          <div>
            <input id="nc_age_years" name="age_years" type="number" min="18" max="100" placeholder="Ej: 35" />
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px;">
        <div class="row">
          <label for="nc_car">¬øTiene coche?</label>
          <div>
            <select id="nc_car" name="car">
              <option value="N">No</option>
              <option value="Y">S√≠</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="nc_realty">¬øTiene propiedad?</label>
          <div>
            <select id="nc_realty" name="realty">
              <option value="Y">S√≠</option>
              <option value="N">No</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="nc_car_age">Edad del coche (a√±os)</label>
          <div>
            <input id="nc_car_age" name="car_age" type="number" min="0" placeholder="Ej: 0" />
          </div>
        </div>
      </div>
    </div>

    <!-- 3) Financiera -->
    <div class="section">
      <p class="section-title">Informaci√≥n financiera</p>
      <div class="grid-2">
        <div class="row">
          <label for="nc_income">Ingreso total anual</label>
          <div>
            <input id="nc_income" name="income" type="number" step="0.01" min="0" placeholder="Ej: 150000" required />
          </div>
        </div>

        <div class="row">
          <label for="nc_income_type">Tipo de ingreso</label>
          <div>
            <select id="nc_income_type" name="income_type">
              <option value="Working">Trabajando</option>
              <option value="Commercial associate">Asociado comercial</option>
              <option value="Pensioner">Pensionista</option>
              <option value="State servant">Funcionario</option>
              <option value="Student">Estudiante</option>
              <option value="Businessman">Empresario</option>
              <option value="Maternity leave">Baja maternidad</option>
              <option value="Unemployed">Desempleado</option>
            </select>
          </div>
        </div>
      </div>
    </div>

      <div class="actions" style="justify-content:space-between;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="button" id="btn-fill-good">üü¢ Ejemplo bueno</button>
          <button class="btn" type="button" id="btn-fill-mid">üü° Ejemplo medio</button>
          <button class="btn" type="button" id="btn-fill-bad">üî¥ Ejemplo malo</button>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="reset">Limpiar</button>
          <button class="btn btn-primary" type="submit">Continuar</button>
        </div>
      </div>


    <div class="status hidden" id="status-new"></div>
  </form>
</section>

    <!-- Confirm -->
    <section id="screen-confirm" class="panel hidden" aria-label="Confirmaci√≥n">
      <div class="panel-header">
        <h3 class="panel-title" id="confirm-title">Confirmar</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btn-confirm-edit" type="button">‚Üê Editar</button>
          <button class="btn hidden" id="btn-edit-client" type="button">Editar cliente</button>
          <button class="btn hidden" id="btn-edit-credit" type="button">Editar cr√©dito</button>
        </div>
      </div>

      <div class="summary" id="confirm-summary"></div>

      <!-- SK asignado (solo para nuevo cliente, se muestra tras registrar) -->
      <div class="summary-row hidden" id="row-sk-assigned">
        <div class="summary-k">ID asignado</div>
        <div class="summary-v" id="ui-sk-assigned">‚Äî</div>
      </div>

      <div class="actions">
        <button class="btn btn-danger" id="btn-confirm-cancel" type="button">Cancelar</button>
        <button class="btn btn-primary" id="btn-confirm-send" type="button">Enviar</button>
      </div>

      <div class="status hidden" id="status-confirm"></div>
    </section>

    <!-- Result -->
    <section id="screen-result" class="panel hidden" aria-label="Resultado">
      <div class="panel-header">
        <h3 class="panel-title">Resultado</h3>
        <button class="btn" id="btn-home" type="button">üè† Inicio</button>
      </div>

      <!-- Visual result (para ni√±os) -->
      <div class="result-hero">
        <div class="result-box">
          <div class="bigRow">
            <div>
              <div class="bigTitle">Riesgo estimado</div>
              <div class="bigValue" id="ui-risk">‚Äî%</div>
            </div>
          </div>
          <!-- Estado (Seguro / Revisi√≥n / Peligro) -->
          <div class="risk-status" id="riskStatusRow" aria-label="Estado del riesgo">
            <span class="badge safe" id="badge-safe">SEGURO</span>
            <span class="badge review" id="badge-review">REVISI√ìN MANUAL</span>
            <span class="badge danger" id="badge-danger">PELIGRO</span>
          </div>

          <!-- Texto explicativo (opcional, pero recomendable) -->
          <div class="risk-status-help" id="riskStatusHelp">‚Äî</div>


          <div class="meter">
            <div class="bigTitle">Riesgo de NO pagar</div>
            <div class="meterBar"><div class="meterFill" id="ui-meter"></div></div>
            <div class="ticks"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
          </div>
        </div>

        <div class="result-box">
          <div class="bigTitle">Resumen f√°cil</div>
          <div class="factMini" id="ui-summary" style="margin-top:8px; line-height:1.45;">
            Aqu√≠ aparecer√° una explicaci√≥n simple.
          </div>

          <details class="json-details">
            <summary>Mostrar JSON t√©cnico (solo si hace falta)</summary>
            <pre class="json-pre" id="ui-json">{}</pre>
          </details>
        </div>
      </div>

      <div class="split">
        <div class="result-box">
          <p class="listTitle">Cosas que SUBEN el riesgo üî∫</p>
          <div id="ui-inc"></div>
          <div class="factMini" id="ui-inc-empty" style="display:none;">No hay factores claros.</div>
        </div>

        <div class="result-box">
          <p class="listTitle">Cosas que BAJAN el riesgo üîª</p>
          <div id="ui-dec"></div>
          <div class="factMini" id="ui-dec-empty" style="display:none;">No hay factores claros.</div>
        </div>
      </div>

      <!-- Status (errores / mensajes cortos) -->
      <div class="status hidden" id="status-result"></div>

      <div class="actions">
        <button class="btn" id="btn-new-request" type="button">Nueva operaci√≥n</button>
      </div>
    </section>
   </main>
  </section>

    <script>
      // "" = mismo host/puerto (recomendado). null = demo.
      let lastScreen = "choice";
      const API_BASE = "";

      // =====================================
      // Presentation toggle
      // =====================================
      function showPresentation(){
        document.getElementById("app")?.classList.add("hidden");
        document.getElementById("presentation")?.classList.remove("hidden");
        document.querySelector(".top-fab")?.classList.add("hidden");
        window.scrollTo(0, 0);
      }

      function showApp(){
        document.getElementById("presentation")?.classList.add("hidden");
        document.getElementById("app")?.classList.remove("hidden");
        document.querySelector(".top-fab")?.classList.remove("hidden");
        window.scrollTo(0, 0);

        navigateTo(lastScreen || "choice");
      }


      const ENDPOINTS = {
        score: "/api/score",
        newClientRegister: "/api/new-client",
        newClientScore: "/api/new-client/score",
        featureLabels: "/api/feature-labels"
      };

      // ================================
      // Risk badges
      // ================================
      function getRiskStatus(riskPct) {
        if (!Number.isFinite(riskPct)) {
          return { key: "review", label: "REVISI√ìN MANUAL", help: "No se pudo calcular el riesgo. Revisi√≥n humana recomendada." };
        }
        if (riskPct < 30) {
          return { key: "safe", label: "SEGURO", help: "Perfil con bajo riesgo estimado." };
        }
        if (riskPct < 60) {
          return { key: "review", label: "REVISI√ìN MANUAL", help: "Riesgo medio. Se recomienda validaci√≥n humana." };
        }
        return { key: "danger", label: "PELIGRO", help: "Riesgo alto de impago. Probable denegaci√≥n." };
      }

      function renderRiskStatus(riskPct) {
        const status = getRiskStatus(riskPct);

        ["safe", "review", "danger"].forEach(k => {
          const el = document.getElementById(`badge-${k}`);
          if (!el) return;
          el.classList.remove("active");
        });

        const active = document.getElementById(`badge-${status.key}`);
        if (active) active.classList.add("active");

        const help = document.getElementById("riskStatusHelp");
        if (help) help.textContent = status.help;
      }

      // =====================================
      // Feature labels (desde FastAPI)
      // =====================================
      let FEATURE_LABELS = {};

      async function loadFeatureLabels() {
        try {
          const resp = await fetch((API_BASE || "") + ENDPOINTS.featureLabels);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          FEATURE_LABELS = await resp.json();
        } catch (e) {
          FEATURE_LABELS = {};
          // aviso leve, no rompe flujo
          console.warn("No se pudieron cargar los labels de features:", e);
        }
      }


      function niceFeatureName(raw) {
        if (!raw) return "‚Äî";
        const k = String(raw).trim();
        if (FEATURE_LABELS[k]) return FEATURE_LABELS[k];

        // fallback: case-insensitive
        const lower = k.toLowerCase();
        const foundKey = Object.keys(FEATURE_LABELS).find(x => x.toLowerCase() === lower);
        return foundKey ? FEATURE_LABELS[foundKey] : k;
      }


      // =====================================
      // HTTP helper
      // =====================================
      async function postJSON(path, payload) {
        if (API_BASE === null) {
          await new Promise(r => setTimeout(r, 600));
          return { demo: true, echo: payload };
        }

        const url = API_BASE + path;
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const ct = resp.headers.get("content-type") || "";
        const isJson = ct.includes("application/json");
        const body = isJson ? await resp.json() : await resp.text();

        if (!resp.ok) {
          const msg = isJson ? (body?.detail || body?.error || JSON.stringify(body)) : String(body);
          throw new Error(msg || `HTTP ${resp.status}`);
        }
        return body;
      }

      // =====================================
      // State (separa registro vs cr√©dito)
      // =====================================
    const state = {
      flow: null,           // "existing" | "new_register" | "new_credit"
      editScreen: null,     // "existing" | "newClient"
      editScreen2: null,    // pantalla secundaria (para poder editar mega-form en new_credit)
      register: null,       // { full_name, dni, email, phone }
      credit: null,         // { amt_credit, credit_type }
      virtualSk: null,      // int (devuelto por /api/new-client)
      newFeatures: null,    // features del mega-form (nuevo cliente)
      _finalPayload: null   // payload listo para enviar
    };

      // =====================================
      // DOM refs
      // =====================================
      const screens = {
        choice: document.getElementById("screen-choice"),
        existing: document.getElementById("screen-existing"),
        newClient: document.getElementById("screen-new"),
        confirm: document.getElementById("screen-confirm"),
        result: document.getElementById("screen-result")
      };

      const steps = {
        s1: document.getElementById("step-1"),
        s2: document.getElementById("step-2"),
        s3: document.getElementById("step-3"),
        s4: document.getElementById("step-4")
      };

      const btnExisting = document.getElementById("btn-existing");
      const btnNew = document.getElementById("btn-new");
      const btnBackExisting = document.getElementById("btn-back-existing");
      const btnBackNew = document.getElementById("btn-back-new");

      const formExisting = document.getElementById("form-existing");
      const formNew = document.getElementById("form-new");

      const statusExisting = document.getElementById("status-existing");
      const statusNew = document.getElementById("status-new");
      const statusConfirm = document.getElementById("status-confirm");
      const statusResult = document.getElementById("status-result");

      const confirmTitle = document.getElementById("confirm-title");
      const confirmSummary = document.getElementById("confirm-summary");
      // Botones presentaci√≥n
      document.getElementById("btn-presentation")?.addEventListener("click", showPresentation);
      document.getElementById("btn-back-to-demo")?.addEventListener("click", showApp);

      // UI: mostrar SK asignado tras registrar nuevo cliente
    const rowSkAssigned = document.getElementById("row-sk-assigned");
    const uiSkAssigned = document.getElementById("ui-sk-assigned");


      const btnConfirmEdit = document.getElementById("btn-confirm-edit");
      const btnConfirmCancel = document.getElementById("btn-confirm-cancel");
      const btnConfirmSend = document.getElementById("btn-confirm-send");
      const btnEditClient = document.getElementById("btn-edit-client");
      const btnEditCredit = document.getElementById("btn-edit-credit");

      const btnHome = document.getElementById("btn-home");
      const btnNewRequest = document.getElementById("btn-new-request");

      const errSk = document.getElementById("err-sk");
      const errAmt = document.getElementById("err-amt");
      const errType = document.getElementById("err-type");

      const errName = document.getElementById("err-name");
      const errDni = document.getElementById("err-dni");
      const errEmail = document.getElementById("err-email");
      const errPhone = document.getElementById("err-phone");

      // Row del SK para ocultar/mostrar
      const skInput = document.getElementById("skIdCurr");
      const skRow = skInput ? skInput.closest(".row") : null;

      // =====================================
      // UI helpers
      // =====================================
      function setStep(activeIdx) {
        [steps.s1, steps.s2, steps.s3, steps.s4].forEach((el, i) =>
          el.classList.toggle("active", i === activeIdx)
        );
      }

      function navigateTo(name) {
        Object.entries(screens).forEach(([k, el]) => el.classList.toggle("hidden", k !== name));
        if (name === "choice") setStep(0);
        if (name === "existing" || name === "newClient") setStep(1);
        if (name === "confirm") setStep(2);
        if (name === "result") setStep(3);

        lastScreen = name;
      }

      function setStatus(el, type, msg) {
        el.classList.remove("hidden", "ok", "err", "warn");
        if (type) el.classList.add(type);
        el.textContent = msg;
      }

      function clearStatus(el) {
        el.classList.add("hidden");
        el.textContent = "";
        el.classList.remove("ok", "err", "warn");
      }

      function setLoading(button, on, text = "Procesando...") {
        if (!button) return;
        if (on) {
          button.dataset.prevText = button.textContent;
          button.textContent = text;
          button.disabled = true;
        } else {
          button.textContent = button.dataset.prevText || button.textContent;
          button.disabled = false;
        }
      }

      function makeKeyboardClickable(el, handler) {
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handler();
          }
        });
      }

      function buildSummaryRows(rows) {
        return rows.map(r => `
          <div class="summary-row">
            <div class="summary-k">${r.k}</div>
            <div class="summary-v">${r.v}</div>
          </div>
        `).join("");
      }

      function creditTypeLabel(v) {
        const map = { revolving_loans: "Cr√©dito revolving", cash_loans: "Pr√©stamo personal" };
        return map[v] || v;
      }

      // =====================================
      // Validations
      // =====================================
        function validateExisting({ requireSk = true } = {}) {
          clearStatus(statusExisting);
          errSk.classList.add("hidden");
          errAmt.classList.add("hidden");
          errType.classList.add("hidden");

          // 1) Calcula SK primero (√∫nica fuente de verdad)
          const sk = requireSk
            ? Number(document.getElementById("skIdCurr").value)
            : Number(state.virtualSk);

          // 2) Si estamos en new_credit, el SK virtual DEBE existir
          if (!requireSk) {
            if (!Number.isFinite(sk) || sk <= 0) {
              setStatus(statusExisting, "err", "No hay SK virtual v√°lido. Vuelve a registrar el cliente.");
              return { ok: false, payload: {} };
            }
          }

          const amt = Number(document.getElementById("amtCredit").value);

          const creditTypeEl = document.getElementById("creditType");
          const type = creditTypeEl.value;
          creditTypeEl.removeAttribute("aria-invalid");

          let ok = true;

          // Si es existing real, validamos el SK del input
          if (requireSk) {
            if (!Number.isFinite(sk) || sk <= 0) {
              errSk.classList.remove("hidden");
              ok = false;
            }
          }

          if (!Number.isFinite(amt) || amt <= 0) {
            errAmt.classList.remove("hidden");
            ok = false;
          }

          if (!type) {
            errType.classList.remove("hidden");
            creditTypeEl.setAttribute("aria-invalid", "true");
            ok = false;
          }

          return {
            ok,
            payload: { sk_id_curr: sk, amt_credit: amt, credit_type: type }
          };
        }

      function validateNew() {
        clearStatus(statusNew);

        errName.classList.add("hidden");
        errDni.classList.add("hidden");
        errEmail.classList.add("hidden");
        errPhone.classList.add("hidden");

        const fullName = String(document.getElementById("fullName").value || "").trim();
        const dni = String(document.getElementById("dni").value || "").trim();
        const email = String(document.getElementById("email").value || "").trim();
        const phone = String(document.getElementById("phone").value || "").trim();

        let ok = true;
        if (!fullName) { errName.classList.remove("hidden"); ok = false; }
        if (!dni) { errDni.classList.remove("hidden"); ok = false; }
        if (!email || !email.includes("@")) { errEmail.classList.remove("hidden"); ok = false; }
        if (!phone) { errPhone.classList.remove("hidden"); ok = false; }

        return { ok, payload: { full_name: fullName, dni, email, phone } };
      }

      function collectNewClientFeatures(){
        const num = (id, fallback=null) => {
          const v = Number(document.getElementById(id)?.value);
          return Number.isFinite(v) ? v : fallback;
        };
        const str = (id, fallback="UNKNOWN") => {
          const el = document.getElementById(id);
          const v = String(el?.value ?? "").trim();
          return v ? v : fallback; // NUNCA null
        };

        return {
          AMT_ANNUITY: num("nc_annuity"),
          AMT_GOODS_PRICE: num("nc_goods_price"),

          CODE_GENDER: str("nc_gender"),
          CNT_CHILDREN: num("nc_children", 0),
          CNT_FAM_MEMBERS: num("nc_family_members"),
          DAYS_BIRTH: (() => {
            const a = num("nc_age_years");
            if (!Number.isFinite(a)) return null;
            const clamped = Math.max(18, Math.min(100, a));
            return -Math.round(clamped * 365.25);
          })(),

          FLAG_OWN_CAR: str("nc_car"),
          FLAG_OWN_REALTY: str("nc_realty"),
          OWN_CAR_AGE: num("nc_car_age"),

          AMT_INCOME_TOTAL: num("nc_income"),
          NAME_INCOME_TYPE: str("nc_income_type"),
        };
      }

      // =====================================
      // Result rendering (dejas lo tuyo)
      // =====================================
      function trimZeros(s){ return s.replace(/\.?0+$/, ""); }

      function formatFeatureValue(feature, value) {
        if (value === null || value === undefined) return "‚Äî";

        const f = String(feature || "").trim();
        const raw = value;

        // Intentar parsear num√©rico cuando se pueda
        let n = null;
        if (typeof raw === "number" && Number.isFinite(raw)) n = raw;
        if (typeof raw === "string") {
          const s = raw.trim();
          if (s !== "" && Number.isFinite(Number(s))) n = Number(s);
        }

        // Helpers
        const asMoney = (x) => {
          if (!Number.isFinite(x)) return String(raw);
          return x.toLocaleString("es-ES", {
            style: "currency",
            currency: "EUR",
            maximumFractionDigits: 0,
          });
        };

        const asInt = (x) => (Number.isFinite(x) ? Math.round(x) : null);

        const yesNo = (x) => {
          const s = String(x).trim().toUpperCase();
          if (s === "Y" || s === "YES" || s === "1" || s === "TRUE") return "S√≠";
          if (s === "N" || s === "NO" || s === "0" || s === "FALSE") return "No";
          return String(x);
        };

        const trimZeros = (s) => String(s).replace(/\.?0+$/, "");

        // Casos especiales
        if (f === "NAME_CONTRACT_TYPE") {
          // soporte num√©rico 0/1
          const mapNum = { 0: "Pr√©stamo personal", 1: "Cr√©dito revolving" };
          if (n !== null && mapNum[n] !== undefined) return mapNum[n];

          // soporte string
          if (typeof raw === "string") {
            const s = raw.trim().toLowerCase();
            if (s === "cash_loans" || s === "cash loans") return "Pr√©stamo personal";
            if (s === "revolving_loans" || s === "revolving loans") return "Cr√©dito revolving";
            return raw.replaceAll("_", " ");
          }
          return String(raw);
        }

        if (f === "CODE_GENDER") {
          // Soporta 0/1 y tambi√©n "M"/"F"
          if (n === 0) return "Mujer";
          if (n === 1) return "Hombre";
          const s = String(raw || "").trim().toUpperCase();
          if (s === "F") return "Mujer";
          if (s === "M") return "Hombre";
          return String(raw);
        }

        if (f.startsWith("EXT_SOURCE_") && n !== null) {
          return `Nota: ${(n * 100).toFixed(1)} / 100`;
        }

        const yesNoFeatures = new Set([
          "FLAG_OWN_CAR","FLAG_OWN_REALTY","FLAG_MOBIL","FLAG_EMP_PHONE","FLAG_WORK_PHONE",
          "FLAG_CONT_MOBILE","FLAG_PHONE","FLAG_EMAIL",
          "REG_REGION_NOT_LIVE_REGION","REG_REGION_NOT_WORK_REGION","LIVE_REGION_NOT_WORK_REGION",
          "REG_CITY_NOT_LIVE_CITY","REG_CITY_NOT_WORK_CITY","LIVE_CITY_NOT_WORK_CITY"
        ]);
        if (yesNoFeatures.has(f)) return yesNo(n ?? raw);

        if (f.startsWith("DAYS_") && n !== null) {
          const days = Math.abs(asInt(n));
          if (n < 0) return `Hace ${days} d√≠as`;
          return `${days} d√≠as`;
        }

        if (f === "OWN_CAR_AGE" && n !== null) return `${asInt(n)} a√±os`;

        const moneyFeatures = new Set([
          "AMT_CREDIT","AMT_ANNUITY","AMT_INCOME_TOTAL","AMT_GOODS_PRICE",
          "prev_amt_mean","prev_amt_max","prev_weighted_amt","inst_amt_paid_1y"
        ]);
        if (moneyFeatures.has(f) && n !== null) return asMoney(n);

        const percentFeatures = new Set([
          "cc_utilization","cc_util_recent","cc_max_utilization","overall_credit_utilization",
          "inst_late_ratio_total","inst_late_ratio_1y","inst_partial_payment_ratio","inst_overpayment_ratio",
          "inst_severe_late_ratio",
          "historical_rejection_rate","prev_approval_rate_6m","prev_approval_rate_12m",
          "total_debt_to_income","debt_to_income_recent","total_overdue_to_income",
          "bureau_dpd_ratio"
        ]);
        if (percentFeatures.has(f) && n !== null) {
          if (n >= 0 && n <= 1) return `${(n * 100).toFixed(1)}%`;
          return `${n.toFixed(1)}%`;
        }

        const trendText = new Set(["bureau_debt_acceleration","pos_dpd_acceleration","cc_balance_trend"]);
        if (trendText.has(f) && n !== null) {
          const a = Math.abs(n);
          if (a < 0.01) return "No cambia casi nada";
          if (n > 0) return "Est√° subiendo r√°pido";
          return "Est√° bajando";
        }

        // Fallback num√©rico / string
        if (n !== null) return trimZeros(n.toFixed(3));
        return String(raw);
      }

      function renderFactors(containerId, emptyId, items, bad){
        const root = document.getElementById(containerId);
        const empty = document.getElementById(emptyId);
        root.innerHTML = "";
        if (!items || items.length === 0){
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        const maxAbs = Math.max(...items.map(x => Math.abs(x.shap))) || 1;

        items.forEach(it => {
          const w = Math.round((Math.abs(it.shap) / maxAbs) * 100);

          const box = document.createElement("div");
          box.className = "fact";
          box.innerHTML = `
            <div class="factTop">
              <div class="factName">${niceFeatureName(it.feature)}</div>
              <div class="factMini">Impacto: ${Number(it.shap).toFixed(3)}</div>
            </div>
            <div class="factMini">Valor: ${formatFeatureValue(it.feature, it.value)}</div>
            <div class="factBar">
              <div class="${bad ? "factFillBad" : "factFillOk"}" style="width:${w}%"></div>
            </div>
          `;
          root.appendChild(box);
        });
      }

      function buildKidSummary(pDefault){
        const pct = pDefault * 100;
        if (!Number.isFinite(pct)) return "No se pudo calcular el riesgo.";
        if (pct < 30) return `Riesgo bajo (${pct.toFixed(2)}%).`;
        if (pct < 60) return `Riesgo medio (${pct.toFixed(2)}%).`;
        return `Riesgo alto (${pct.toFixed(2)}%).`;
      }


      function renderResultUI(res){
        document.getElementById("ui-json").textContent = JSON.stringify(res, null, 2);

        const pDefault = res?.proba?.default;
        if (typeof pDefault !== "number"){
          document.getElementById("ui-risk").textContent = "‚Äî%";
          document.getElementById("ui-meter").style.width = "0%";
          document.getElementById("ui-summary").textContent = "No se pudo calcular el riesgo.";
          renderRiskStatus(NaN);
          return;
        }

        const pct = pDefault * 100;
        document.getElementById("ui-risk").textContent = pct.toFixed(2) + "%";
        document.getElementById("ui-meter").style.width = Math.max(0, Math.min(100, Math.round(pct))) + "%";

        renderRiskStatus(pct);
        document.getElementById("ui-summary").textContent = buildKidSummary(pDefault);

        renderFactors("ui-inc", "ui-inc-empty", res?.shap?.top_risk_increasing || [], true);
        renderFactors("ui-dec", "ui-dec-empty", res?.shap?.top_risk_decreasing || [], false);
      }

      // =====================================
      // Wiring (flujo correcto)
      // =====================================
      btnExisting.addEventListener("click", () => {
        state.flow = "existing";
        state.editScreen = "existing";
        if (skRow) skRow.classList.remove("hidden"); // SK visible en existing real
        const title = document.querySelector("#screen-existing .panel-title");
        if (title) title.textContent = "Cliente existente ‚Üí Datos del cr√©dito";
        navigateTo("existing");
        document.getElementById("skIdCurr").focus();
      });
      makeKeyboardClickable(btnExisting, () => btnExisting.click());

      btnNew.addEventListener("click", () => {
        state.flow = "new_register";
        state.editScreen = "newClient";
        navigateTo("newClient");
        document.getElementById("fullName").focus();
      });
      makeKeyboardClickable(btnNew, () => btnNew.click());

    function resetAll(){
      formExisting.reset();
      formNew.reset();

      clearStatus(statusExisting);
      clearStatus(statusNew);
      clearStatus(statusConfirm);
      clearStatus(statusResult);

      document.getElementById("ui-risk").textContent = "‚Äî%";
      document.getElementById("ui-meter").style.width = "0%";
      document.getElementById("ui-summary").textContent = "Aqu√≠ aparecer√° una explicaci√≥n simple.";
      document.getElementById("ui-inc").innerHTML = "";
      document.getElementById("ui-dec").innerHTML = "";
      document.getElementById("ui-json").textContent = "{}";

      renderRiskStatus(NaN);
      btnEditClient?.classList.add("hidden");
      btnEditCredit?.classList.add("hidden");

      state.flow = null;
      state.editScreen = null;
      state.editScreen2 = null;
      state.register = null;
      state.credit = null;
      state.virtualSk = null;
      state.newFeatures = null;
      state._finalPayload = null;

      if (skRow) skRow.classList.remove("hidden");
      const title = document.querySelector("#screen-existing .panel-title");
      if (title) title.textContent = "Cliente existente ‚Üí Datos del cr√©dito";

      // Reset UI del SK asignado
      if (rowSkAssigned && uiSkAssigned) {
        rowSkAssigned.classList.add("hidden");
        uiSkAssigned.textContent = "‚Äî";
      }


      navigateTo("choice");
    }

    // Reemplaza handlers:
    btnBackExisting.addEventListener("click", resetAll);
    btnBackNew.addEventListener("click", resetAll);
    btnHome.addEventListener("click", resetAll);
    btnNewRequest.addEventListener("click", resetAll);
    btnConfirmCancel.addEventListener("click", resetAll);


      // 1) Existing credit form
      formExisting.addEventListener("submit", (e) => {
        e.preventDefault();

        // Si estamos en new_credit, no pedimos SK manual
        const requireSk = (state.flow !== "new_credit");
        const v = validateExisting({ requireSk });

        if (!v.ok) {
          setStatus(statusExisting, "err", "Corrige los campos marcados.");
          return;
        }

        // Guardar cr√©dito
        state.credit = { amt_credit: v.payload.amt_credit, credit_type: v.payload.credit_type };

        if (state.flow === "existing") {
          confirmTitle.textContent = "Confirmar scoring (cliente existente)";
          confirmSummary.innerHTML = buildSummaryRows([
            { k:"SK_ID_CURR", v:String(v.payload.sk_id_curr) },
            { k:"Cantidad", v:`${state.credit.amt_credit.toFixed(2)} ‚Ç¨` },
            { k:"Tipo", v:creditTypeLabel(state.credit.credit_type) }
          ]);

          // payload final para /api/score
          state._finalPayload = {
            sk_id_curr: v.payload.sk_id_curr,
            amt_credit: state.credit.amt_credit,
            credit_type: state.credit.credit_type
          };
        } else {
          // payload final para /api/new-client/score
          confirmTitle.textContent = "Confirmar solicitud (nuevo cliente)";
          confirmSummary.innerHTML = buildSummaryRows([
            { k:"SK virtual", v:String(v.payload.sk_id_curr) },
            { k:"Cantidad", v:`${state.credit.amt_credit.toFixed(2)} ‚Ç¨` },
            { k:"Tipo", v:creditTypeLabel(state.credit.credit_type) }
          ]);

          state._finalPayload = {
            sk_id_curr: v.payload.sk_id_curr,
            amt_credit: state.credit.amt_credit,
            credit_type: state.credit.credit_type,
            features: state.newFeatures || {}
          };
        }
        // Mostrar botones extra solo si estamos en new_credit (ya hay cliente + estamos editando cr√©dito)
        if (state.flow === "new_credit") {
          btnEditClient?.classList.remove("hidden");
          btnEditCredit?.classList.remove("hidden");
        } else {
          btnEditClient?.classList.add("hidden");
          btnEditCredit?.classList.add("hidden");
        }

        navigateTo("confirm");
      });

      // 2) New client register form
      formNew.addEventListener("submit", (e) => {
        e.preventDefault();

        const v = validateNew();
        if (!v.ok) {
          setStatus(statusNew, "err", "Corrige los campos marcados.");
          return;
        }

        state.register = v.payload;

        // ‚úÖ GUARDAR FEATURES DEL MEGA-FORM
        state.newFeatures = collectNewClientFeatures();

        confirmTitle.textContent = "Confirmar registro (nuevo cliente)";
        confirmSummary.innerHTML = buildSummaryRows([
          { k: "Nombre", v: state.register.full_name },
          { k: "DNI/NIE", v: state.register.dni },
          { k: "Email", v: state.register.email },
          { k: "Tel√©fono", v: state.register.phone }
        ]);
        // Mostrar botones extra solo si estamos en new_credit (ya hay cliente + estamos editando cr√©dito)
        if (state.flow === "new_credit") {
          btnEditClient?.classList.remove("hidden");
          btnEditCredit?.classList.remove("hidden");
        } else {
          btnEditClient?.classList.add("hidden");
          btnEditCredit?.classList.add("hidden");
        }
        navigateTo("confirm");
      });

      // --- Botones "Editar cliente / Editar cr√©dito" (se conectan UNA SOLA VEZ) ---
      btnEditCredit?.addEventListener("click", () => {
        clearStatus(statusConfirm);
        navigateTo("existing");
      });

      btnEditClient?.addEventListener("click", () => {
        clearStatus(statusConfirm);
        navigateTo("newClient");
      });

      // --- Bot√≥n "‚Üê Editar" (sin popups) ---
      btnConfirmEdit.addEventListener("click", () => {
        clearStatus(statusConfirm);

        // En new_credit, "‚Üê Editar" te manda al cr√©dito por defecto.
        // Si quieres editar cliente, usas el bot√≥n "Editar cliente".
        if (state.flow === "new_credit") {
          navigateTo("existing");
          return;
        }

        navigateTo(state.editScreen);
      });

      // 3) Confirm send (seg√∫n flujo)
      btnConfirmSend.addEventListener("click", async () => {
        clearStatus(statusConfirm);
        clearStatus(statusResult);
        setLoading(btnConfirmSend, true, "Enviando...");

        try {
          // =========================
          // 1) Cliente existente
          // =========================
          if (state.flow === "existing") {
            const res = await postJSON(ENDPOINTS.score, state._finalPayload);
            renderResultUI(res);
            navigateTo("result");
            return;
          }

          // =========================
          // 2) Registro nuevo cliente
          //    (AQU√ç va el cambio)
          // =========================
          if (state.flow === "new_register") {
            // ‚úÖ Ahora guardamos tambi√©n las features del mega-form en el registro del backend
            const regPayload = {
              ...state.register,
              features: state.newFeatures || {}
            };

            const reg = await postJSON(ENDPOINTS.newClientRegister, regPayload);
            const sk = reg?.sk_id_curr;

            if (!Number.isFinite(Number(sk))) {
              throw new Error("El backend no devolvi√≥ sk_id_curr en el registro.");
            }

            state.virtualSk = Number(sk);

            // Mostrar en la pantalla de Confirm el ID asignado
            if (rowSkAssigned && uiSkAssigned) {
              uiSkAssigned.textContent = String(state.virtualSk);
              rowSkAssigned.classList.remove("hidden");
            }

            // Pasar a pedir cr√©dito (reutiliza el formulario de 'existing')
            state.flow = "new_credit";
            state.editScreen = "existing";
            state.editScreen2 = "newClient";

            if (skRow) skRow.classList.add("hidden"); // ocultar SK manual
            const title = document.querySelector("#screen-existing .panel-title");
            if (title) title.textContent = "Nuevo cliente ‚Üí Datos del cr√©dito";

            setStatus(
            statusExisting,
            "ok",
            `Registro OK.\nID asignado: ${state.virtualSk}\nAhora introduce el cr√©dito.`
          );

            navigateTo("existing");
            return;
          }

          // =========================
          // 3) Scoring nuevo cliente
          // =========================
          if (state.flow === "new_credit") {
            const res = await postJSON(ENDPOINTS.newClientScore, state._finalPayload);
            renderResultUI(res);
            navigateTo("result");
            return;
          }

          throw new Error("Estado de flujo desconocido.");
        } catch (err) {
          setStatus(statusConfirm, "err", "Error:\n" + (err?.message || String(err)));
        } finally {
          setLoading(btnConfirmSend, false);
        }
      });


      // =====================================
// DEMO: Autocompletar 3 perfiles
// (rellena mega-form + deja listo el cr√©dito del siguiente paso)
// =====================================
function setVal(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  el.value = value;
  // dispara validaciones UI si las tienes enganchadas a input/change
  el.dispatchEvent(new Event("input", { bubbles: true }));
  el.dispatchEvent(new Event("change", { bubbles: true }));
}

function fillProfile(p) {
  // Identificaci√≥n
  setVal("fullName", p.fullName);
  setVal("dni", p.dni);
  setVal("email", p.email);
  setVal("phone", p.phone);

  // Contrato (mega-form)
  setVal("nc_contract_type", p.contractType); // "Cash loans" | "Revolving loans"
  setVal("nc_annuity", p.annuity);
  setVal("nc_goods_price", p.goodsPrice);

  // Personal
  setVal("nc_gender", p.gender); // "M" | "F"
  setVal("nc_children", p.children);
  setVal("nc_family_members", p.familyMembers);
  setVal("nc_age_years", p.ageYears);
  setVal("nc_car", p.ownCar);       // "Y" | "N"
  setVal("nc_realty", p.ownRealty); // "Y" | "N"
  setVal("nc_car_age", p.carAge);

  // Financiera
  setVal("nc_income", p.income);
  setVal("nc_income_type", p.incomeType);

  // Cr√©dito del paso siguiente (form-existing)
  // Nota: el "Tipo de cr√©dito" en existing usa revolving_loans/cash_loans
  setVal("amtCredit", p.creditAmount);
  setVal("creditType", p.creditType); // "cash_loans" | "revolving_loans"
}

// 3 perfiles para demo (coherentes)
const DEMO_PROFILES = {
  good: {
    fullName: "Ana Mart√≠nez L√≥pez",
    dni: "12345678Z",
    email: "ana.martinez.demo@gmail.com",
    phone: "611222333",
    contractType: "Cash loans",
    annuity: 4800,
    goodsPrice: 12000,
    gender: "F",
    children: 0,
    familyMembers: 1,
    ageYears: 34,
    ownCar: "N",
    ownRealty: "Y",
    carAge: 0,
    income: 52000,
    incomeType: "Working",
    creditAmount: 9000,
    creditType: "cash_loans",
  },
  mid: {
    fullName: "Juan P√©rez Garc√≠a",
    dni: "87654321X",
    email: "juan.perez.demo@gmail.com",
    phone: "600123123",
    contractType: "Cash loans",
    annuity: 7200,
    goodsPrice: 15000,
    gender: "M",
    children: 0,
    familyMembers: 2,
    ageYears: 29,
    ownCar: "Y",
    ownRealty: "N",
    carAge: 6,
    income: 28000,
    incomeType: "Working",
    creditAmount: 12000,
    creditType: "cash_loans",
  },
  bad: {
    fullName: "Carlos G√≥mez Ruiz",
    dni: "11223344A",
    email: "carlos.gomez.demo@gmail.com",
    phone: "699888777",
    contractType: "Revolving loans",
    annuity: 14000,
    goodsPrice: 25000,
    gender: "M",
    children: 3,
    familyMembers: 5,
    ageYears: 22,
    ownCar: "Y",
    ownRealty: "N",
    carAge: 15,
    income: 12000,
    incomeType: "Unemployed",
    creditAmount: 25000,
    creditType: "revolving_loans",
  },
};

// Botones
document.getElementById("btn-fill-good")?.addEventListener("click", () => {
  fillProfile(DEMO_PROFILES.good);
  setStatus(statusNew, "ok", "Ejemplo BUENO cargado. Pulsa Continuar.");
});

document.getElementById("btn-fill-mid")?.addEventListener("click", () => {
  fillProfile(DEMO_PROFILES.mid);
  setStatus(statusNew, "ok", "Ejemplo MEDIO cargado. Pulsa Continuar.");
});

document.getElementById("btn-fill-bad")?.addEventListener("click", () => {
  fillProfile(DEMO_PROFILES.bad);
  setStatus(statusNew, "warn", "Ejemplo MALO cargado. Pulsa Continuar.");
});

      // init (al final)
      loadFeatureLabels().finally(() => navigateTo("choice"));
    </script>
  </body>
</html>