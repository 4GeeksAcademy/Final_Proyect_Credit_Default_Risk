<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitud de cr√©dito</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --card2:#0f1626; --text:#e8eefc; --muted:#a9b4cc;
      --border:rgba(255,255,255,0.12); --focus:rgba(120,160,255,0.45);
      --ok:rgba(34,197,94,.35); --err:rgba(239,68,68,.35); --warn:rgba(245,158,11,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1000px 700px at 20% 10%, #142241 0%, transparent 55%),
                  radial-gradient(900px 650px at 90% 30%, #1b2c54 0%, transparent 50%),
                  var(--bg);
      color:var(--text); min-height:100vh; display:grid; place-items:center; padding:24px;
    }
    .container{width:100%; max-width:920px}
    h1{margin:0 0 10px; font-size:22px}
    .subtitle{margin:0 0 18px; color:var(--muted); font-size:14px; line-height:1.35}

    .stepper{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 16px}
    .step{border:1px solid var(--border); background:rgba(255,255,255,0.04); color:var(--muted);
      padding:7px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .step.active{color:var(--text); border-color:rgba(120,160,255,0.55); box-shadow:0 0 0 4px rgba(120,160,255,0.10)}

    .choice-grid{display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:16px}
    .choice-card{
      background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:18px; min-height:160px;
      display:grid; gap:10px; cursor:pointer; user-select:none;
      transition:transform .12s ease, border-color .12s ease;
    }
    .choice-card:hover{transform:translateY(-2px); border-color:rgba(255,255,255,0.22)}
    .badge{justify-self:start; display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px}
    .choice-title{margin:0; font-size:18px; font-weight:800}
    .choice-desc{margin:0; color:var(--muted); font-size:14px; line-height:1.35}

    .panel{
      margin-top:18px; background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:18px;
    }
    .panel-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
    .panel-title{margin:0; font-size:16px; font-weight:800}

    .btn{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,0.06);
      color:var(--text); border-radius:10px; padding:10px 12px; cursor:pointer;
      transition:border-color .12s ease, transform .12s ease, opacity .12s ease;
      font-weight:700; font-size:13px;
    }
    .btn:hover{border-color:rgba(255,255,255,0.25); transform:translateY(-1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .btn-primary{background:rgba(120,160,255,0.22); border-color:rgba(120,160,255,0.5)}
    .btn-danger{background:rgba(239,68,68,0.14); border-color:rgba(239,68,68,0.35)}

    .form-grid{display:grid; gap:12px; margin-top:10px}
    .row{
      display:grid; grid-template-columns:220px 1fr; gap:12px; align-items:center;
      padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.03);
    }
    label{font-size:13px; color:var(--muted); font-weight:700}
  input, select{
    width:100%;
    padding:11px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(0,0,0,0.18);
    color:var(--text);
    outline:none;
    font-size:14px;
  }

  select{
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    padding-right:46px;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%),
      linear-gradient(to right, rgba(255,255,255,0.12), rgba(255,255,255,0.12));
    background-position:
      calc(100% - 18px) 50%,
      calc(100% - 12px) 50%,
      calc(100% - 40px) 50%;
    background-size:6px 6px, 6px 6px, 1px 60%;
    background-repeat:no-repeat;
  }

  select option{
    background:#0f1626;
    color:#e8eefc;
  }

  select:invalid{ color: rgba(169,180,204,0.85); }
  select option[value=""]{ color: rgba(169,180,204,0.85); }

    input:focus, select:focus{
      border-color:rgba(120,160,255,0.55);
      box-shadow:0 0 0 4px var(--focus);
    }

    .field-error{margin-top:6px; font-size:12px; color:rgba(255,255,255,0.85)}
    .field-error strong{color:rgba(239,68,68,0.95)}
    .hidden{display:none !important}


    .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap}
    .status{
      margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(0,0,0,0.18); color:var(--muted); white-space:pre-wrap;
    }
    .status.ok{border-color:var(--ok)} .status.err{border-color:var(--err)} .status.warn{border-color:var(--warn)}

    .summary{border:1px solid var(--border); background:rgba(255,255,255,0.03); border-radius:12px; overflow:hidden}
    .summary-row{display:grid; grid-template-columns:220px 1fr; gap:12px; padding:12px; border-bottom:1px solid var(--border)}
    .summary-row:last-child{border-bottom:0}
    .summary-k{color:var(--muted); font-weight:800; font-size:13px}
    .summary-v{font-weight:800}

    /* =============================
       RESULT UI (VISUAL + NI√ëOS)
       ============================= */
    .result-hero{
      display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:12px;
    }
    .result-box{
      border:1px solid var(--border);
      background:rgba(0,0,0,0.18);
      border-radius:14px;
      padding:14px;
    }
    .bigRow{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .bigTitle{font-size:12px; color:var(--muted); font-weight:800}
    .bigValue{font-size:22px; font-weight:900}

    .traffic{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border);
      font-weight:900; letter-spacing:.3px;
    }
    .traffic.safe{border-color:var(--ok); background:rgba(34,197,94,.12)}
    .traffic.care{border-color:var(--warn); background:rgba(245,158,11,.12)}
    .traffic.danger{border-color:var(--err); background:rgba(239,68,68,.12)}

    .meter{margin-top:10px}
    .meterTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .meterBar{
      height:14px; border-radius:999px; overflow:hidden;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.08);
      margin-top:8px;
    }
    .meterFill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.8), rgba(245,158,11,.8), rgba(239,68,68,.8));
      transition:width .25s ease
    }
    .ticks{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:6px}

    .split{
      display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px;
    }
    .listTitle{margin:0 0 10px; font-size:13px; color:var(--muted); font-weight:900; text-transform:uppercase; letter-spacing:.6px}

    .fact{
      padding:10px; border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      margin-bottom:10px;
    }
    .factTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline}
    .factName{font-weight:900}
    .factMini{color:var(--muted); font-size:12px}
    .factBar{height:10px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,0.08); border:1px solid var(--border); margin-top:8px}
    .factFillBad{height:100%; width:0%; background:rgba(239,68,68,.75); transition:width .25s ease}
    .factFillOk{height:100%; width:0%; background:rgba(34,197,94,.75); transition:width .25s ease}

    details.json-details{margin-top:12px}
    details.json-details summary{cursor:pointer; color:var(--muted); font-weight:800}
    pre.json-pre{
      margin:10px 0 0;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      max-height:340px;
      font-size:12px;
      color: var(--text);
    }

    @media (max-width:720px){
      .choice-grid{grid-template-columns:1fr}
      .row, .summary-row{grid-template-columns:1fr}
      .result-hero{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <main class="container">
    <h1>Solicitud de cr√©dito</h1>
    <p class="subtitle">Frontend conectado a FastAPI (scoring existente + registro nuevo). Explicaci√≥n visual para demo.</p>

    <div class="stepper" aria-label="Progreso">
      <span class="step" id="step-1">1) Selecci√≥n</span>
      <span class="step" id="step-2">2) Datos</span>
      <span class="step" id="step-3">3) Confirmar</span>
      <span class="step" id="step-4">4) Resultado</span>
    </div>

    <section id="screen-choice" class="choice-grid" aria-label="Selecci√≥n">
      <div class="choice-card" id="btn-existing" role="button" tabindex="0">
        <span class="badge">üë§ Cliente existente</span>
        <h2 class="choice-title">Cliente existente</h2>
        <p class="choice-desc">Calcula riesgo usando SK_ID_CURR.</p>
      </div>

      <div class="choice-card" id="btn-new" role="button" tabindex="0">
        <span class="badge">‚ú® Nuevo cliente</span>
        <h2 class="choice-title">Nuevo cliente</h2>
        <p class="choice-desc">Registro de cliente.</p>
      </div>
    </section>

    <!-- Existing -->
    <section id="screen-existing" class="panel hidden" aria-label="Existente">
      <div class="panel-header">
        <h3 class="panel-title">Cliente existente ‚Üí Datos del cr√©dito</h3>
        <button class="btn" id="btn-back-existing" type="button">‚Üê Volver</button>
      </div>

      <form id="form-existing" novalidate>
        <div class="form-grid">
          <div class="row">
            <label for="skIdCurr">SK_ID_CURR</label>
            <div>
              <input id="skIdCurr" name="skIdCurr" type="number" min="1" placeholder="Ej: 10293" required />
              <div class="field-error hidden" id="err-sk"><strong>Error:</strong> SK_ID_CURR debe ser un n√∫mero > 0.</div>
            </div>
          </div>

          <div class="row">
            <label for="amtCredit">Cantidad de cr√©dito</label>
            <div>
              <input id="amtCredit" name="amtCredit" type="number" min="0" step="0.01" placeholder="Ej: 5000" required />
              <div class="field-error hidden" id="err-amt"><strong>Error:</strong> La cantidad debe ser mayor que 0.</div>
            </div>
          </div>

          <div class="row">
            <label for="creditType">Tipo de cr√©dito</label>
            <div>
              <select id="creditType" name="creditType" required aria-required="true" aria-describedby="err-type">
                <option value="" selected disabled>Selecciona un tipo de cr√©dito</option>
                <option value="revolving_loans">Cr√©dito revolving</option>
                <option value="cash_loans">Pr√©stamo personal</option>
              </select>
              <div class="field-error hidden" id="err-type"><strong>Error:</strong> Selecciona un tipo de cr√©dito.</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="reset">Limpiar</button>
          <button class="btn btn-primary" type="submit">Continuar</button>
        </div>

        <div class="status hidden" id="status-existing"></div>
      </form>
    </section>

    <!-- New -->
    <section id="screen-new" class="panel hidden" aria-label="Nuevo cliente">
      <div class="panel-header">
        <h3 class="panel-title">Nuevo cliente ‚Üí Registro</h3>
        <button class="btn" id="btn-back-new" type="button">‚Üê Volver</button>
      </div>

      <form id="form-new" novalidate>
        <div class="form-grid">
          <div class="row">
            <label for="fullName">Nombre completo</label>
            <div>
              <input id="fullName" name="fullName" type="text" placeholder="Ej: Juan P√©rez" required />
              <div class="field-error hidden" id="err-name"><strong>Error:</strong> Nombre requerido.</div>
            </div>
          </div>

          <div class="row">
            <label for="dni">DNI/NIE</label>
            <div>
              <input id="dni" name="dni" type="text" placeholder="Ej: 12345678Z" required />
              <div class="field-error hidden" id="err-dni"><strong>Error:</strong> DNI/NIE requerido.</div>
            </div>
          </div>

          <div class="row">
            <label for="email">Email</label>
            <div>
              <input id="email" name="email" type="email" placeholder="Ej: juan@email.com" required />
              <div class="field-error hidden" id="err-email"><strong>Error:</strong> Email v√°lido requerido.</div>
            </div>
          </div>

          <div class="row">
            <label for="phone">Tel√©fono</label>
            <div>
              <input id="phone" name="phone" type="tel" placeholder="Ej: 600123123" required />
              <div class="field-error hidden" id="err-phone"><strong>Error:</strong> Tel√©fono requerido.</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="reset">Limpiar</button>
          <button class="btn btn-primary" type="submit">Continuar</button>
        </div>

        <div class="status hidden" id="status-new"></div>
      </form>
    </section>

    <!-- Confirm -->
    <section id="screen-confirm" class="panel hidden" aria-label="Confirmaci√≥n">
      <div class="panel-header">
        <h3 class="panel-title" id="confirm-title">Confirmar</h3>
        <button class="btn" id="btn-confirm-edit" type="button">‚Üê Editar</button>
      </div>

      <div class="summary" id="confirm-summary"></div>

      <div class="actions">
        <button class="btn btn-danger" id="btn-confirm-cancel" type="button">Cancelar</button>
        <button class="btn btn-primary" id="btn-confirm-send" type="button">Enviar</button>
      </div>

      <div class="status hidden" id="status-confirm"></div>
    </section>

    <!-- Result -->
    <section id="screen-result" class="panel hidden" aria-label="Resultado">
      <div class="panel-header">
        <h3 class="panel-title">Resultado</h3>
        <button class="btn" id="btn-home" type="button">üè† Inicio</button>
      </div>

      <!-- Visual result (para ni√±os) -->
      <div class="result-hero">
        <div class="result-box">
          <div class="bigRow">
            <div>
              <div class="bigTitle">Decisi√≥n</div>
              <div class="bigValue" id="ui-decision">‚Äî</div>
            </div>
            <div class="traffic care" id="ui-traffic">‚Äî</div>
          </div>

          <div class="meter">
            <div class="meterTop">
              <div class="bigTitle">Riesgo de NO pagar</div>
              <div class="bigValue" id="ui-risk">‚Äî%</div>
            </div>
            <div class="meterBar"><div class="meterFill" id="ui-meter"></div></div>
            <div class="ticks"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
            <div class="factMini" style="margin-top:8px;">
              Umbral del sistema: <span id="ui-threshold">‚Äî</span>
            </div>
          </div>
        </div>

        <div class="result-box">
          <div class="bigTitle">Resumen f√°cil</div>
          <div class="factMini" id="ui-summary" style="margin-top:8px; line-height:1.45;">
            Aqu√≠ aparecer√° una explicaci√≥n simple.
          </div>

          <details class="json-details">
            <summary>Mostrar JSON t√©cnico (solo si hace falta)</summary>
            <pre class="json-pre" id="ui-json">{}</pre>
          </details>
        </div>
      </div>

      <div class="split">
        <div class="result-box">
          <p class="listTitle">Cosas que SUBEN el riesgo üî∫</p>
          <div id="ui-inc"></div>
          <div class="factMini" id="ui-inc-empty" style="display:none;">No hay factores claros.</div>
        </div>

        <div class="result-box">
          <p class="listTitle">Cosas que BAJAN el riesgo üîª</p>
          <div id="ui-dec"></div>
          <div class="factMini" id="ui-dec-empty" style="display:none;">No hay factores claros.</div>
        </div>
      </div>

      <!-- Status (errores / mensajes cortos) -->
      <div class="status hidden" id="status-result"></div>

      <div class="actions">
        <button class="btn" id="btn-new-request" type="button">Nueva operaci√≥n</button>
      </div>
    </section>
  </main>

  <script>
    // "" = mismo host/puerto (recomendado). null = demo.
    const API_BASE = "";

    const ENDPOINTS = {
      score: "/api/score",
      newClient: "/api/new-client",
      featureLabels: "/api/feature-labels"
    };

    // =====================================
// Feature labels (se cargan desde FastAPI)
// =====================================
let FEATURE_LABELS = {};

async function loadFeatureLabels(){
  try{
    const resp = await fetch((API_BASE || "") + ENDPOINTS.featureLabels);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    FEATURE_LABELS = await resp.json();
  } catch (e){
    FEATURE_LABELS = {}; // fallback seguro
  }
}

function niceFeatureName(raw){
  if (!raw) return "‚Äî";
  const k = String(raw).trim();
  return FEATURE_LABELS[k] || k;
}



    async function postJSON(path, payload){
      if (API_BASE === null){
        await new Promise(r => setTimeout(r, 600));
        return { demo: true, echo: payload };
      }

      const url = API_BASE + path;
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const ct = resp.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      const body = isJson ? await resp.json() : await resp.text();

      if (!resp.ok){
        const msg = isJson ? (body?.detail || body?.error || JSON.stringify(body)) : String(body);
        throw new Error(msg || `HTTP ${resp.status}`);
      }
      return body;
    }

    const state = { flow: null, payload: null, editScreen: null };

    const screens = {
      choice: document.getElementById("screen-choice"),
      existing: document.getElementById("screen-existing"),
      newClient: document.getElementById("screen-new"),
      confirm: document.getElementById("screen-confirm"),
      result: document.getElementById("screen-result")
    };

    const steps = {
      s1: document.getElementById("step-1"),
      s2: document.getElementById("step-2"),
      s3: document.getElementById("step-3"),
      s4: document.getElementById("step-4")
    };

    const btnExisting = document.getElementById("btn-existing");
    const btnNew = document.getElementById("btn-new");
    const btnBackExisting = document.getElementById("btn-back-existing");
    const btnBackNew = document.getElementById("btn-back-new");

    const formExisting = document.getElementById("form-existing");
    const formNew = document.getElementById("form-new");

    const statusExisting = document.getElementById("status-existing");
    const statusNew = document.getElementById("status-new");
    const statusConfirm = document.getElementById("status-confirm");
    const statusResult = document.getElementById("status-result");

    const confirmTitle = document.getElementById("confirm-title");
    const confirmSummary = document.getElementById("confirm-summary");

    const btnConfirmEdit = document.getElementById("btn-confirm-edit");
    const btnConfirmCancel = document.getElementById("btn-confirm-cancel");
    const btnConfirmSend = document.getElementById("btn-confirm-send");

    const btnHome = document.getElementById("btn-home");
    const btnNewRequest = document.getElementById("btn-new-request");

    const errSk = document.getElementById("err-sk");
    const errAmt = document.getElementById("err-amt");
    const errType = document.getElementById("err-type");

    const errName = document.getElementById("err-name");
    const errDni = document.getElementById("err-dni");
    const errEmail = document.getElementById("err-email");
    const errPhone = document.getElementById("err-phone");

    function setStep(activeIdx){
      [steps.s1, steps.s2, steps.s3, steps.s4].forEach((el, i) => el.classList.toggle("active", i === activeIdx));
    }

    function navigateTo(name){
      Object.entries(screens).forEach(([k, el]) => el.classList.toggle("hidden", k !== name));
      if (name === "choice") setStep(0);
      if (name === "existing" || name === "newClient") setStep(1);
      if (name === "confirm") setStep(2);
      if (name === "result") setStep(3);
    }

    function setStatus(el, type, msg){
      el.classList.remove("hidden","ok","err","warn");
      if (type) el.classList.add(type);
      el.textContent = msg;
    }

    function clearStatus(el){
      el.classList.add("hidden");
      el.textContent = "";
      el.classList.remove("ok","err","warn");
    }

    function setLoading(button, on, text="Procesando..."){
      if (!button) return;
      if (on){
        button.dataset.prevText = button.textContent;
        button.textContent = text;
        button.disabled = true;
      } else {
        button.textContent = button.dataset.prevText || button.textContent;
        button.disabled = false;
      }
    }

    function makeKeyboardClickable(el, handler){
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          handler();
        }
      });
    }

    function validateExisting(){
      clearStatus(statusExisting);
      errSk.classList.add("hidden");
      errAmt.classList.add("hidden");
      errType.classList.add("hidden");

      const sk = Number(document.getElementById("skIdCurr").value);
      const amt = Number(document.getElementById("amtCredit").value);

      const creditTypeEl = document.getElementById("creditType");
      const type = creditTypeEl.value;

      // reset accesibilidad
      creditTypeEl.removeAttribute("aria-invalid");

      let ok = true;
      if (!Number.isFinite(sk) || sk <= 0){ errSk.classList.remove("hidden"); ok = false; }
      if (!Number.isFinite(amt) || amt <= 0){ errAmt.classList.remove("hidden"); ok = false; }
      if (!type){
        errType.classList.remove("hidden");
        creditTypeEl.setAttribute("aria-invalid", "true");
        ok = false;
      }

      return { ok, payload: { sk_id_curr: sk, amt_credit: amt, credit_type: type } };
    }

    function validateNew(){
      clearStatus(statusNew);
      [errName, errDni, errEmail, errPhone].forEach(e => e.classList.add("hidden"));

      const fullName = document.getElementById("fullName").value.trim();
      const dni = document.getElementById("dni").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();

      let ok = true;
      if (!fullName){ errName.classList.remove("hidden"); ok = false; }
      if (!dni){ errDni.classList.remove("hidden"); ok = false; }
      if (!email || !email.includes("@")){ errEmail.classList.remove("hidden"); ok = false; }
      if (!phone){ errPhone.classList.remove("hidden"); ok = false; }

      return { ok, payload: { full_name: fullName, dni, email, phone } };
    }

    function buildSummaryRows(rows){
      return rows.map(r => `
        <div class="summary-row">
          <div class="summary-k">${r.k}</div>
          <div class="summary-v">${r.v}</div>
        </div>
      `).join("");
    }

    function creditTypeLabel(v){
      const map = {
        revolving_loans: "Cr√©dito revolving",
        cash_loans: "Pr√©stamo personal"
      };
      return map[v] || v;
    }



function formatFeatureValue(feature, value){
  if (value === null || value === undefined) return "‚Äî";

  const f = String(feature || "").trim();
  const raw = value;

  // Normaliza n√∫mero si viene como string num√©rico (SIEMPRE aqu√≠ dentro)
  let n = null;
  if (typeof raw === "number" && Number.isFinite(raw)) n = raw;
  if (typeof raw === "string"){
    const s = raw.trim();
    if (s !== "" && Number.isFinite(Number(s))) n = Number(s);
  }

  // Contrato (si llega como 0/1 o string)
  if (f === "NAME_CONTRACT_TYPE"){
    const mapNum = { 0: "Pr√©stamo personal", 1: "Cr√©dito revolving" };
    if (n !== null && mapNum[n] !== undefined) return mapNum[n];

    if (typeof raw === "string"){
      const s = raw.trim().toLowerCase();
      if (s === "cash_loans" || s === "cash loans") return "Pr√©stamo personal";
      if (s === "revolving_loans" || s === "revolving loans") return "Cr√©dito revolving";
      return raw.replaceAll("_", " ");
    }

    return String(raw);
  }

  // Scores externos
  if (f.startsWith("EXT_SOURCE_") && n !== null){
    return `Nota: ${(n * 100).toFixed(1)} / 100`;
  }

  // Helpers
  const asMoney = (x) => {
    if (!Number.isFinite(x)) return String(raw);
    return x.toLocaleString("es-ES", { style:"currency", currency:"EUR", maximumFractionDigits:0 });
  };
  const asInt = (x) => Number.isFinite(x) ? Math.round(x) : null;
  const yesNo = (x) => (Number(x) === 1 ? "S√≠" : "No");

  if (f === "CODE_GENDER"){
    if (n === 0) return "Mujer";
    if (n === 1) return "Hombre";
    return String(raw);
  }

  const yesNoFeatures = new Set([
    "FLAG_OWN_CAR","FLAG_OWN_REALTY","FLAG_MOBIL","FLAG_EMP_PHONE","FLAG_WORK_PHONE",
    "FLAG_CONT_MOBILE","FLAG_PHONE","FLAG_EMAIL",
    "REG_REGION_NOT_LIVE_REGION","REG_REGION_NOT_WORK_REGION","LIVE_REGION_NOT_WORK_REGION",
    "REG_CITY_NOT_LIVE_CITY","REG_CITY_NOT_WORK_CITY","LIVE_CITY_NOT_WORK_CITY"
  ]);
  if (yesNoFeatures.has(f)){
    return yesNo(n ?? raw);
  }

  if (f.startsWith("DAYS_") && n !== null){
    const days = Math.abs(asInt(n));
    if (n < 0) return `Hace ${days} d√≠as`;
    return `${days} d√≠as`;
  }

  if (f === "OWN_CAR_AGE" && n !== null){
    return `${asInt(n)} a√±os`;
  }

  const moneyFeatures = new Set([
    "AMT_CREDIT","AMT_ANNUITY","AMT_INCOME_TOTAL","AMT_GOODS_PRICE",
    "prev_amt_mean","prev_amt_max","prev_weighted_amt","inst_amt_paid_1y"
  ]);
  if (moneyFeatures.has(f) && n !== null){
    return asMoney(n);
  }

  const percentFeatures = new Set([
    "cc_utilization","cc_util_recent","cc_max_utilization","overall_credit_utilization",
    "inst_late_ratio_total","inst_late_ratio_1y","inst_partial_payment_ratio","inst_overpayment_ratio",
    "inst_severe_late_ratio",
    "historical_rejection_rate","prev_approval_rate_6m","prev_approval_rate_12m",
    "total_debt_to_income","debt_to_income_recent","total_overdue_to_income",
    "bureau_dpd_ratio"
  ]);
  if (percentFeatures.has(f) && n !== null){
    if (n >= 0 && n <= 1) return `${(n * 100).toFixed(1)}%`;
    return `${n.toFixed(1)}%`;
  }

  const trendText = new Set([
    "bureau_debt_acceleration","pos_dpd_acceleration","cc_balance_trend"
  ]);
  if (trendText.has(f) && n !== null){
    const a = Math.abs(n);
    if (a < 0.01) return "No cambia casi nada";
    if (n > 0) return "Est√° subiendo r√°pido";
    return "Est√° bajando";
  }

  const dpdLike = ["dpd","late","payment_gap","dbd","overdue"];
  if (n !== null && dpdLike.some(k => f.toLowerCase().includes(k))){
    if (f.toLowerCase().includes("days") || f.toLowerCase().includes("dpd") || f.toLowerCase().includes("dbd")){
      return `${asInt(n)} d√≠as`;
    }
  }

  if (n !== null){
    return trimZeros(n.toFixed(3));
  }
  return String(raw);
}

function trimZeros(s){
  return s.replace(/\.?0+$/, "");
}


    function setTraffic(pDefault){
      const el = document.getElementById("ui-traffic");
      el.classList.remove("safe","care","danger");
      if (pDefault < 0.10){
        el.classList.add("safe");
        el.textContent = "‚úÖ SEGURO";
      } else if (pDefault < 0.30){
        el.classList.add("care");
        el.textContent = "‚ö†Ô∏è REVISI√ìN MANUAL";
      } else {
        el.classList.add("danger");
        el.textContent = "‚ùå PELIGRO";
      }
    }

    function renderFactors(containerId, emptyId, items, bad){
      const root = document.getElementById(containerId);
      const empty = document.getElementById(emptyId);
      root.innerHTML = "";
      if (!items || items.length === 0){
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      const maxAbs = Math.max(...items.map(x => Math.abs(x.shap))) || 1;

      items.forEach(it => {
        const w = Math.round((Math.abs(it.shap) / maxAbs) * 100);

        const box = document.createElement("div");
        box.className = "fact";
        box.innerHTML = `
          <div class="factTop">
            <div class="factName">${niceFeatureName(it.feature)}</div>
            <div class="factMini">Impacto: ${Number(it.shap).toFixed(3)}</div>
          </div>
          <div class="factMini">Valor: ${formatFeatureValue(it.feature, it.value)}</div>
          <div class="factBar">
            <div class="${bad ? "factFillBad" : "factFillOk"}" style="width:${w}%"></div>
          </div>
        `;
        root.appendChild(box);
      });
    }

    function buildKidSummary(pDefault, decision){
      const pct = (pDefault * 100).toFixed(2);
      if (decision === "APPROVE"){
        if (pDefault < 0.10) return `Riesgo bajo (${pct}%). Parece un cliente bastante seguro.`;
        if (pDefault < 0.30) return `Riesgo medio (${pct}%). Se puede aprobar, pero con cuidado.`;
        return `Riesgo alto (${pct}%). Aunque salga ‚Äúaprobado‚Äù, yo lo mirar√≠a con lupa.`;
      } else {
        if (pDefault < 0.30) return `Lo rechaza por la regla del umbral, aunque el riesgo no sea enorme (${pct}%).`;
        return `Riesgo alto (${pct}%). El sistema lo rechaza para evitar impagos.`;
      }
    }

    function renderResultUI(res){
      // JSON t√©cnico
      document.getElementById("ui-json").textContent = JSON.stringify(res, null, 2);

      const pDefault = res?.proba?.default;
      const decision = res?.decision;
      const thr = res?.threshold;

      if (typeof pDefault !== "number"){
        document.getElementById("ui-decision").textContent = "‚Äî";
        document.getElementById("ui-risk").textContent = "‚Äî%";
        document.getElementById("ui-meter").style.width = "0%";
        document.getElementById("ui-summary").textContent = "No se pudo calcular el riesgo.";
        document.getElementById("ui-threshold").textContent = String(thr ?? "‚Äî");
        return;
      }

      const pct = pDefault * 100;
      document.getElementById("ui-risk").textContent = pct.toFixed(2) + "%";
      document.getElementById("ui-meter").style.width = Math.max(0, Math.min(100, Math.round(pct))) + "%";
      document.getElementById("ui-decision").textContent = (decision === "APPROVE") ? "APROBADO ‚úÖ" : "RECHAZADO ‚ùå";
      document.getElementById("ui-threshold").textContent = String(thr ?? "‚Äî");
      setTraffic(pDefault);
      document.getElementById("ui-summary").textContent = buildKidSummary(pDefault, decision);
      
      renderFactors("ui-inc", "ui-inc-empty", res?.shap?.top_risk_increasing || [], true);
      renderFactors("ui-dec", "ui-dec-empty", res?.shap?.top_risk_decreasing || [], false);
    }

    // ===== Wiring de pantallas =====
    btnExisting.addEventListener("click", () => {
      state.flow = "existing";
      state.editScreen = "existing";
      navigateTo("existing");
      document.getElementById("skIdCurr").focus();
    });
    makeKeyboardClickable(btnExisting, () => btnExisting.click());

    btnNew.addEventListener("click", () => {
      state.flow = "new";
      state.editScreen = "newClient";
      navigateTo("newClient");
      document.getElementById("fullName").focus();
    });
    makeKeyboardClickable(btnNew, () => btnNew.click());

    btnBackExisting.addEventListener("click", () => navigateTo("choice"));
    btnBackNew.addEventListener("click", () => navigateTo("choice"));

    btnHome.addEventListener("click", () => navigateTo("choice"));
    btnNewRequest.addEventListener("click", () => {
      formExisting.reset();
      formNew.reset();
      clearStatus(statusExisting);
      clearStatus(statusNew);
      clearStatus(statusConfirm);
      clearStatus(statusResult);
      // limpia UI resultado
      document.getElementById("ui-decision").textContent = "‚Äî";
      document.getElementById("ui-risk").textContent = "‚Äî%";
      document.getElementById("ui-meter").style.width = "0%";
      document.getElementById("ui-summary").textContent = "Aqu√≠ aparecer√° una explicaci√≥n simple.";
      document.getElementById("ui-threshold").textContent = "‚Äî";
      document.getElementById("ui-inc").innerHTML = "";
      document.getElementById("ui-dec").innerHTML = "";
      document.getElementById("ui-json").textContent = "{}";
      navigateTo("choice");
    });

    formExisting.addEventListener("submit", (e) => {
      e.preventDefault();
      const v = validateExisting();
      if (!v.ok){
        setStatus(statusExisting, "err", "Corrige los campos marcados.");
        return;
      }
      state.payload = v.payload;

      confirmTitle.textContent = "Confirmar scoring (cliente existente)";
      confirmSummary.innerHTML = buildSummaryRows([
        { k:"SK_ID_CURR", v:String(state.payload.sk_id_curr) },
        { k:"Cantidad", v:`${state.payload.amt_credit.toFixed(2)} ‚Ç¨` },
        { k:"Tipo", v:creditTypeLabel(state.payload.credit_type) }
      ]);

      navigateTo("confirm");
    });

    formNew.addEventListener("submit", (e) => {
      e.preventDefault();
      const v = validateNew();
      if (!v.ok){
        setStatus(statusNew, "err", "Corrige los campos marcados.");
        return;
      }
      state.payload = v.payload;

      confirmTitle.textContent = "Confirmar registro (nuevo cliente)";
      confirmSummary.innerHTML = buildSummaryRows([
        { k:"Nombre", v: state.payload.full_name },
        { k:"DNI/NIE", v: state.payload.dni },
        { k:"Email", v: state.payload.email },
        { k:"Tel√©fono", v: state.payload.phone }
      ]);

      navigateTo("confirm");
    });

    btnConfirmEdit.addEventListener("click", () => {
      clearStatus(statusConfirm);
      navigateTo(state.editScreen);
    });

    btnConfirmCancel.addEventListener("click", () => {
      clearStatus(statusConfirm);
      navigateTo("choice");
    });

    btnConfirmSend.addEventListener("click", async () => {
      clearStatus(statusConfirm);
      clearStatus(statusResult);
      setLoading(btnConfirmSend, true, "Enviando...");

      try {
        if (state.flow === "existing"){
          const res = await postJSON(ENDPOINTS.score, state.payload);
          // Render bonito (modo ni√±os)
          renderResultUI(res);
          navigateTo("result");
        } else {
          const res = await postJSON(ENDPOINTS.newClient, state.payload);
          // Para nuevo cliente, mostramos mensaje simple (sin gr√°fica)
          setStatus(statusResult, "ok",
            `‚úÖ Cliente registrado.\nID asignado: ${res.client_id ?? "(sin id)"}\nEstado: ${res.status ?? "OK"}\n`
          );
          // Y dejamos el JSON por si acaso
          document.getElementById("ui-json").textContent = JSON.stringify(res, null, 2);
          // Dejamos valores en blanco en el dashboard (no aplica)
          document.getElementById("ui-decision").textContent = "‚Äî";
          document.getElementById("ui-risk").textContent = "‚Äî%";
          document.getElementById("ui-meter").style.width = "0%";
          document.getElementById("ui-summary").textContent = "Registro completado. Para ver riesgo, usa ‚ÄúCliente existente‚Äù.";
          document.getElementById("ui-threshold").textContent = "‚Äî";
          document.getElementById("ui-inc").innerHTML = "";
          document.getElementById("ui-dec").innerHTML = "";
          navigateTo("result");
        }
      } catch (err){
        setStatus(statusConfirm, "err", "Error:\n" + (err?.message || String(err)));
      } finally {
        setLoading(btnConfirmSend, false);
      }
    });

    // init
      loadFeatureLabels().finally(() => navigateTo("choice"));
  </script>
</body>
</html>